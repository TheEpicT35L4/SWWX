<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Weather & Space Monitor - Dark Theme</title>
    
    <!-- Leaflet CSS + JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Mapbox GL JS for better dark basemap -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
    
    <!-- ToGeoJSON for converting NHC KML to GeoJSON -->
    <script src="https://cdn.jsdelivr.net/npm/@tmcw/togeojson@0.16.0"></script>
    
    <style>
        body, html {
            height: 100%; margin: 0; padding: 0;
            background: #0d1117; color: #e6edf3;
            font-family: Arial, Helvetica, sans-serif;
        }
        #container { display: flex; flex-direction: column; height: 100%; }
        #main { flex: 1; display: flex; }
        #sidebar {
            width: 320px; background: #161b22; padding: 12px;
            overflow-y: auto; border-right: 1px solid #30363d;
        }
        #map { flex: 1; }
        #solar-bar {
            height: 250px; background: #0d1117; border-top: 1px solid #30363d;
            overflow-x: auto; white-space: nowrap; padding: 10px;
            display: flex; align-items: flex-start; gap: 20px;
        }
        .alert-item {
            padding: 10px; margin-bottom: 10px; border-radius: 6px;
            background: #21262d; font-size: 0.9em;
        }
        .advisory  { background: #1e40af; } /* blue */
        .watch     { background: #854d0e; color: #fef08a; } /* yellow */
        .warning   { background: #7f1d1d; } /* red */
        .pds       { background: #5b21b6; } /* purple */
        .title     { font-size: 1.3em; margin: 0 0 15px 0; text-align: center; }
        .suvi-section {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
        }
        img.suvi-img {
            width: 300px; height: 300px; border-radius: 4px; box-shadow: 0 0 8px rgba(0,0,0,0.6);
        }
        .play-btn {
            padding: 6px 12px; background: #238636; color: white;
            border: none; border-radius: 4px; cursor: pointer;
        }
        /* Popup styling for readability */
        .mapboxgl-popup-content {
            background: #161b22 !important;
            color: #e6edf3 !important;
            padding: 10px;
            border-radius: 6px;
            font-family: Arial;
        }
        .mapboxgl-popup-tip {
            border-top-color: #161b22 !important;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="main">
            <div id="sidebar">
                <h2 class="title">NWS Active Alerts (US)</h2>
                <div id="alerts-list">Loading alerts...</div>
            </div>
            <div id="map"></div>
        </div>
        
        <div id="solar-bar">
            <!-- SUVI sections will be injected here -->
        </div>
    </div>

    <script>
        // ================= MAP SETUP =================
        mapboxgl.accessToken = 'pk.eyJ1IjoidG90YWxseXQiLCJhIjoiY21rOWNuY3c3MW1taDNnb2p0NG5vMnp3NiJ9.XiPPcGPMiWjzm39gu2RQmw';
        
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [-95, 38], // Center on US
            zoom: 4
        });

        map.addControl(new mapboxgl.NavigationControl());

        // Add live radar overlay on load
        map.on('load', () => {
            map.addSource('radar', {
                'type': 'raster',
                'tiles': ['https://mapservices.weather.noaa.gov/eventdriven/rest/services/radar/radar_base_reflectivity/MapServer/tile/{z}/{y}/{x}'],
                'tileSize': 256
            });
            map.addLayer({
                'id': 'radar-layer',
                'type': 'raster',
                'source': 'radar',
                'paint': {
                    'raster-opacity': 0.6
                }
            });
        });

        // ================= NWS ALERTS (LEFT SIDEBAR) =================
        async function loadAlerts() {
            try {
                const res = await fetch('https://api.weather.gov/alerts/active?area=US&status=actual', {
                    headers: {
                        'User-Agent': 'WeatherMonitorApp/1.0 (your.email@example.com)' // Required by NWS API
                    }
                });
                const data = await res.json();
                const list = document.getElementById('alerts-list');
                list.innerHTML = '';

                if (!data.features?.length) {
                    list.innerHTML = '<p>No active alerts at this time.</p>';
                    return;
                }

                data.features.forEach(f => {
                    const p = f.properties;
                    const severity = (p.severity || '').toLowerCase();
                    let className = 'alert-item ';
                    if (severity.includes('advisory')) className += 'advisory';
                    else if (severity.includes('watch')) className += 'watch';
                    else if (severity.includes('warning')) className += 'warning';
                    else className += 'pds'; // fallback for PDS/extreme

                    const div = document.createElement('div');
                    div.className = className;
                    div.innerHTML = `
                        <strong>${p.event || 'Alert'}</strong><br>
                        <small>${p.areaDesc || 'Various areas'}</small><br>
                        <small>${p.headline || p.description.substring(0,80)+'...'}</small>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                document.getElementById('alerts-list').innerHTML = '<p>Error loading alerts (check console).</p>';
                console.error(e);
            }
        }

        // ================= USGS EARTHQUAKES =================
        async function loadQuakes() {
            try {
                const res = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_day.geojson');
                const data = await res.json();

                data.features.forEach(f => {
                    const mag = f.properties.mag;
                    if (!mag) return;
                    
                    let color = 'gray';
                    if (mag >= 7.7) color = 'pink';
                    else if (mag >= 6.7) color = 'red';
                    else if (mag >= 6.0) color = 'orange';
                    else if (mag >= 5.0) color = 'yellow';
                    else if (mag >= 3.5) color = 'green';

                    const coords = f.geometry.coordinates;
                    new mapboxgl.Marker({
                        color: color,
                        scale: Math.max(0.6, mag / 5)
                    })
                    .setLngLat([coords[0], coords[1]])
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <strong>M${mag.toFixed(1)}</strong><br>
                        ${f.properties.place || 'Unknown'}<br>
                        ${new Date(f.properties.time).toLocaleString()}
                    `))
                    .addTo(map);
                });
            } catch (e) { console.error('Quake load error', e); }
        }

        // ================= NHC CONES / TRACKS =================
        async function loadNHC() {
            try {
                const kmlRes = await fetch('https://www.nhc.noaa.gov/gis/kml/nhc_active.kml');
                const kmlText = await kmlRes.text();
                const dom = new DOMParser().parseFromString(kmlText, 'text/xml');
                const geojson = toGeoJSON.kml(dom);

                if (geojson.features.length === 0) {
                    console.log('No active NHC systems (normal for off-season)');
                    return;
                }

                L.geoJSON(geojson, {
                    style: feature => {
                        if (feature.geometry.type === 'Polygon' || feature.geometry.type === 'MultiPolygon') {
                            return { color: '#ff6b6b', weight: 2, opacity: 0.7, fillOpacity: 0.15 };
                        }
                        return { color: '#ffcc00', weight: 4 };
                    },
                    onEachFeature: (feature, layer) => {
                        if (feature.properties.description) {
                            layer.bindPopup(feature.properties.description);
                        }
                    }
                }).addTo(map);
            } catch (e) { console.error('NHC load error', e); }
        }

        // ================= SUVI SOLAR IMAGERY (BOTTOM, PER BAND ANIMATION) =================
        const bands = ['Fe094', 'Fe131', 'Fe171', 'Fe195', 'Fe284', 'He304'];
        const solarContainer = document.getElementById('solar-bar');
        bands.forEach(band => {
            const section = document.createElement('div');
            section.className = 'suvi-section';
            section.innerHTML = `<h4>${band} Ã…</h4>`;
            const img = document.createElement('img');
            img.className = 'suvi-img';
            const playBtn = document.createElement('button');
            playBtn.className = 'play-btn';
            playBtn.textContent = 'Play Animation';
            section.appendChild(img);
            section.appendChild(playBtn);
            solarContainer.appendChild(section);

            // Load latest animated GIF (4-hour loop)
            // Pattern: Fetch a recent GIF; for simplicity, use a base URL and assume latest is accessible
            // (In practice, replace with dynamic fetch if proxy available; here using example from pattern)
            const gifUrl = `https://cdn.star.nesdis.noaa.gov/GOES19/SUVI/FD/${band}/latest.gif`; // Ideal, but use fallback to static if not
            img.src = gifUrl;
            img.alt = `${band} Animation`;
            img.onerror = () => {
                // Fallback to latest static if GIF fails
                img.src = `https://cdn.star.nesdis.noaa.gov/GOES19/SUVI/FD/${band}/latest-600x600.jpg`;
            };

            // Play/Pause toggles GIF animation (since GIFs loop naturally, button just for user control if needed)
            let playing = false;
            playBtn.onclick = () => {
                playing = !playing;
                if (playing) {
                    img.src = img.src; // Restart GIF
                    playBtn.textContent = 'Pause';
                } else {
                    // To "pause" GIF, replace with static version (hacky but works)
                    const staticUrl = img.src.replace('.gif', '.jpg'); // Approximate
                    img.src = staticUrl;
                    playBtn.textContent = 'Play Animation';
                }
            };
        });

        // Load everything on start
        loadAlerts();
        loadQuakes();
        loadNHC();

        // Auto-refresh
        setInterval(loadAlerts, 300000); // 5 min
        setInterval(loadQuakes, 600000); // 10 min
    </script>
</body>
</html>
